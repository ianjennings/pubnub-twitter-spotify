
<html>
  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js" type="text/javascript"></script>
    <script src="http://cdn.embed.ly/jquery.embedly-3.1.1.min.js" type="text/javascript"></script>
    <link href='http://fonts.googleapis.com/css?family=Oxygen:400,700,300' rel='stylesheet' type='text/css'>
    <link href='http://cdn.jsdelivr.net/animatecss/3.2.0/animate.min.css' rel='stylesheet' type='text/css'>
  </head>
  <title>Popular Spotify Tracks Posted On Twitter</title>
  <style type="text/css">
    body {
      background-color: #000;
      overflow: hidden;
    }
    * {
      margin: 0px;
      padding: 0px;
      text-align: center;
      font-family: 'Oxygen', sans-serif;
    }
    h1,h2,h3,h4,h5 {
      margin: 10px 0px;
    }
    h1 {
      margin-top: 0px;
      font-size: 36px;
      font-weight: bold;
      background-color: white;
      padding: 30px;
      color: #333;
      text-transform: uppercase;
    }
    h2 {
      font-size: 24px;
      text-transform: uppercase;
    }
    h3 {
      font-size: 14px;
    }
    .info {
      text-align: left;
    }
    .album {
      opacity: .9;
      float: left;
      width: 10%;
    }
    .album img {
      width: 100%;
    }
    #output {
      width: 100%;
      height: 100%;
    }
    .tweet-show {
      display: none;
      position: fixed;
      left: 0px;
      width: 100px;
      height: 100px;
      z-index: 2;
      text-align: center;
      width: 100%;
      color: #fff;
      font-size: 42px;
      text-shadow: 0px 0px 10px #000;
      bottom: 0px;
      background-color: #111;
      opacity: .5;
      padding: 20px 0px;
    }
    .album:hover {
      opacity: 1;
    }
    .album:hover .tweet-show {
      display: block;
    }
  </style>
  <body>
    <div id="output"></div>
    <div id="tweet"></div>
    <script src="http://cdn.pubnub.com/pubnub.min.js"></script>
    <a href="http://pubnub.com"><img src="https://brandfolder.com/pubnub/assets/xemvalf8" width="200px" alt="Powered By PubNub Color"></a>
    <script>    

      var $tweet = $('#tweet');
      var $output = $('#output');

      var handleTweets = function(tweets) {

        var links = [];
        for(var i = 0; i < tweets.length; i++) {

          var link = findLink(tweets[i]);

          if(typeof link !== "undefined" && link) {
            
            links.push(link);
            
            var $html = $('\
              <a class="album" href="' + link +'" data-link="' + link + '"><div class="tweet-show">' + tweets[i].text + '</div><div class="image"></div></a> \
            ');

            if($('.album').length) {
              var randomel = Math.floor((Math.random()* $('.album').length )+1);
              $('.album:nth-child(' + randomel + ')').addClass('animated rollOut').one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function(e, el) {
                $(this).remove();
              }).before($html);
            } else {
              $('#output').append($html);
            }

          }

        }

        $.embedly.oembed(links, {key: '5f535050d3f9484c94cd07ea3121299b', batch: 10}).progress(function(oembed){

          alert('calledback')

          if(oembed && typeof oembed !== "undefined") {

            if(oembed.thumbnail_width / oembed.thumbnail_height == 1) {

              var $html = $('<img src="' + oembed.thumbnail_url + '" class="animated rollIn">');
              var placeholder = $('.album[data-link="' + oembed.original_url + '"] .image');

              placeholder.html($html);
              i++;
               
            }

          }

        });

        // delete albums with index > x
        $('.album:gt(200)').remove();
        $('.album:eq(0)').addClass('over');
        $('.album:gt(0)').removeClass('over');

      };

      var pubnub = PUBNUB.init({
        subscribe_key: 'sub-c-78806dd4-42a6-11e4-aed8-02ee2ddab7fe'
      });

      var findLink = function(tweet) {
        var links = tweet.entities.urls;
        if(links) {
          return links[(links.length - 1)].expanded_url; 
        } else {
          return false;
        }
      }

      var history_count = 80;
      var count = 0;
      pubnub.history({
        channel: 'pubnub-twitter-spotify',
        count: history_count,
        callback: function(m){
          handleTweets(m[0]);
        },
      });

      // subscribe to twitter / spotify feed
      pubnub.subscribe({
        channel: 'pubnub-twitter-spotify',
        message: function(tweet) { 
          handleTweets([tweet]);
        }
      });
        
    </script>
  </body>
</html>